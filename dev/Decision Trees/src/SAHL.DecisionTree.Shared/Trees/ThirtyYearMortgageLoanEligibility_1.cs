
using Microsoft.Scripting.Hosting;
using SAHL.Core.SystemMessages;
using Newtonsoft.Json;
using System.Collections.Generic;
using System.Linq;
using System;
using System.Reflection;
using System.Dynamic;
using SAHL.DecisionTree.Shared.Interfaces;
using SAHL.DecisionTree.Shared.Core;
using SAHL.DecisionTree.Shared.Helpers;

namespace SAHL.DecisionTree.Shared.Trees
{
    public class ThirtyYearMortgageLoanEligibility_1 : IDecisionTree
    {
        private int currentNodeId;
        private bool currentResult;
        private ScriptScope scope;
        private bool nodeExecutionResultedInError;
        private dynamic variablesCollection;
        private ISystemMessageCollection systemMessageCollection;

        private Dictionary<string, ISystemMessageCollection> SubtreeMessagesDictionary { get; set; }
        private List<string> SubtreeMessagesToClear { get; set; }
        
        public List<Link> NodeLinks {get; private set;}
        public Dictionary<int, Node> Nodes {get; private set;}
        public QueryGlobalsVersion GlobalsVersion { get; protected set; }

        public ThirtyYearMortgageLoanEligibility_1(ISystemMessageCollection messages)
        {
            this.NodeLinks = new List<Link>() { new Link(0,-2,-1,LinkType.DecisionYes), new Link(1,-2,-38,LinkType.DecisionNo), new Link(2,-1,-23,LinkType.Standard), new Link(3,-6,-8,LinkType.Standard), new Link(4,-4,-8,LinkType.DecisionYes), new Link(5,-4,-6,LinkType.DecisionNo), new Link(6,-8,-9,LinkType.DecisionYes), new Link(7,-8,-10,LinkType.DecisionNo), new Link(8,-10,-9,LinkType.Standard), new Link(9,-9,-12,LinkType.DecisionYes), new Link(10,-12,-14,LinkType.Standard), new Link(11,-9,-14,LinkType.DecisionNo), new Link(12,-15,-17,LinkType.Standard), new Link(13,-19,-20,LinkType.DecisionNo), new Link(14,-20,-24,LinkType.Standard), new Link(15,-24,-26,LinkType.DecisionYes), new Link(16,-24,-27,LinkType.DecisionNo), new Link(17,-27,-26,LinkType.Standard), new Link(18,-26,-30,LinkType.DecisionYes), new Link(19,-30,-32,LinkType.Standard), new Link(20,-26,-32,LinkType.DecisionNo), new Link(21,-32,-23,LinkType.DecisionYes), new Link(22,-32,-33,LinkType.DecisionNo), new Link(23,-33,-23,LinkType.Standard), new Link(24,-14,-17,LinkType.DecisionYes), new Link(25,-14,-15,LinkType.DecisionNo), new Link(26,-17,-19,LinkType.DecisionYes), new Link(27,-17,-24,LinkType.DecisionNo), new Link(28,-19,-24,LinkType.DecisionYes), new Link(29,-23,-22,LinkType.DecisionYes), new Link(30,-23,-36,LinkType.DecisionNo), new Link(31,-22,-36,LinkType.Standard), new Link(32,1,-25,LinkType.Standard), new Link(33,-25,-2,LinkType.Standard), new Link(34,-28,-4,LinkType.DecisionNo), new Link(35,-28,-29,LinkType.DecisionYes), new Link(36,-29,-4,LinkType.Standard), new Link(37,-31,-34,LinkType.DecisionYes), new Link(38,-37,-35,LinkType.DecisionYes), new Link(39,-35,-31,LinkType.Standard), new Link(40,-37,-31,LinkType.DecisionNo), new Link(41,-34,-28,LinkType.Standard), new Link(42,-31,-28,LinkType.DecisionNo), new Link(43,-38,-39,LinkType.DecisionYes), new Link(44,-38,-37,LinkType.DecisionNo), new Link(45,-39,-37,LinkType.Standard)};
            this.Nodes = new Dictionary<int, Node>() {{1, new Node(1,"Start",NodeType.Start,@"")},{-2, new Node(-2,"30 Year Mortgage blocked by Credit",NodeType.Decision,@"if Variables::inputs.ApplicationBlockedByCredit == true  then_newline_  Variables::outputs.NodeResult = true_newline_else_newline_ Variables::outputs.NodeResult = false_newline_end")},{-1, new Node(-1,"Display Warning Message For Application Denied by Credit",NodeType.Process,@"Messages.AddWarning(_sgl_quote_Credit declined 30 year term._sgl_quote_)_newline_Variables::outputs.QualifiesForThirtyYearLoanTerm = false")},{-4, new Node(-4,"Loan Purpose = New Purchase",NodeType.Decision,@"if Variables::inputs.MortgageLoanApplicationType ==  Enumerations::sAHomeLoans::mortgageLoanApplicationType.NewPurchase then_newline_  Variables::outputs.NodeResult = true_newline_else_newline_ Variables::outputs.NodeResult = false_newline_end")},{-6, new Node(-6,"Display Warning Message For New Purchase Loans Only",NodeType.Process,@"Messages.AddWarning(_sgl_quote_Only New Purchase applications allowed._sgl_quote_)_newline_Variables::outputs.QualifiesForThirtyYearLoanTerm = false")},{-8, new Node(-8,"Product = New Variable Loan",NodeType.Decision,@"if Variables::inputs.Product == Enumerations::sAHomeLoans::mortgageLoanProductType.NewVariable then_newline_  Variables::outputs.NodeResult = true_newline_else_newline_ Variables::outputs.NodeResult = false_newline_end")},{-9, new Node(-9,"Highest Income Contributor Salary Type = Self Employed",NodeType.Decision,@"if Variables::inputs.HighestIncomeContributorSalaryType == Enumerations::sAHomeLoans::householdIncomeType.SelfEmployed then_newline_  Variables::outputs.NodeResult = true_newline_else_newline_ Variables::outputs.NodeResult = false_newline_end")},{-10, new Node(-10,"Display Warning Message for New Variable Loans Only",NodeType.Process,@"Messages.AddWarning(_sgl_quote_Only New Variable applications allowed._sgl_quote_)_newline_Variables::outputs.QualifiesForThirtyYearLoanTerm = false")},{-12, new Node(-12,"Display Warning Message for Self Employed Highest Income Contributor",NodeType.Process,@"Messages.AddWarning(_sgl_quote_Not for Self Employed applications._sgl_quote_)_newline_Variables::outputs.QualifiesForThirtyYearLoanTerm = false")},{-14, new Node(-14,"Highest Income Contributor Age <= 45",NodeType.Decision,@"if Variables::inputs.HighestIncomeContributorAge <= 45  then_newline_  Variables::outputs.NodeResult = true_newline_else_newline_ Variables::outputs.NodeResult = false_newline_end")},{-15, new Node(-15,"Display Warning Message for Highest Income Contributor Age",NodeType.Process,@"Messages.AddWarning(_sgl_quote_Highest income contributor to be below the age of 45 years._sgl_quote_)_newline_Variables::outputs.QualifiesForThirtyYearLoanTerm = false")},{-17, new Node(-17,"Highest Income Contributor Age >= 40 Years Old",NodeType.Decision,@"if Variables::inputs.HighestIncomeContributorAge >= 40  then_newline_  Variables::outputs.NodeResult = true_newline_else_newline_ Variables::outputs.NodeResult = false_newline_end")},{-19, new Node(-19,"Household Income >= R40 000",NodeType.Decision,@"if Variables::inputs.HouseholdIncome >= 40000  then_newline_  Variables::outputs.NodeResult = true_newline_else_newline_ Variables::outputs.NodeResult = false_newline_end")},{-20, new Node(-20,"Display Warning Message for Income Where Highest Income Contributor Over 40 Years",NodeType.Process,@"Messages.AddWarning(_sgl_quote_Highest income contributor is above the age of 40 years and the household income is below R40 000.00._sgl_quote_)_newline_Variables::outputs.QualifiesForThirtyYearLoanTerm = false")},{-24, new Node(-24,"Highest Income Contributor Credit Score >= 595",NodeType.Decision,@"if Variables::inputs.HighestIncomeContributorCreditScore >= 595  then_newline_  Variables::outputs.NodeResult = true_newline_else_newline_ Variables::outputs.NodeResult = false_newline_end")},{-26, new Node(-26,"LTV > 95",NodeType.Decision,@"if Variables::inputs.CurrentLTV > 0.95  then_newline_  Variables::outputs.NodeResult = true_newline_else_newline_ Variables::outputs.NodeResult = false_newline_end")},{-27, new Node(-27,"Display Warning Message for Highest Income Contributor Credit Score",NodeType.Process,@"Messages.AddWarning(_sgl_quote_Highest income contributor credit score is below 595._sgl_quote_)_newline_Variables::outputs.QualifiesForThirtyYearLoanTerm = false")},{-30, new Node(-30,"Display Warning Message for LTV",NodeType.Process,@"Messages.AddWarning(_sgl_quote_Only available for LTV less than or equal to 95%._sgl_quote_)_newline_Variables::outputs.QualifiesForThirtyYearLoanTerm = false")},{-32, new Node(-32,"Current PTI <= 30%",NodeType.Decision,@"if Variables::inputs.CurrentPTI <= 0.30  then_newline_  Variables::outputs.NodeResult = true_newline_else_newline_ Variables::outputs.NodeResult = false_newline_end")},{-33, new Node(-33,"Display Warning Message for PTI",NodeType.Process,@"Messages.AddWarning(_sgl_quote_Current PTI is above 30% for 30 Year term._sgl_quote_)_newline_Variables::outputs.QualifiesForThirtyYearLoanTerm = false")},{-36, new Node(-36,"End",NodeType.End,@"")},{-22, new Node(-22,"Calculate 30Year Term Financials",NodeType.Process,@"Variables::outputs.PricingAdjustmentThirtyYear = 0.003_newline_Variables::outputs.InterestRateThirtyYear = Variables::inputs.InterestRate + Variables::outputs.PricingAdjustmentThirtyYear_newline__newline_Variables::outputs.InstalmentThirtyYear = ((Variables::outputs.InterestRateThirtyYear / 12.0) + ((Variables::outputs.InterestRateThirtyYear / 12.0) / ((((Variables::outputs.InterestRateThirtyYear / 12.0).to_f + 1.0) ** 360.0) - 1))) * Variables::inputs.LoanAmount_newline_Variables::outputs.InstalmentThirtyYear = (Variables::outputs.InstalmentThirtyYear).truncate_to(2)_newline__newline__newline_Variables::outputs.PaymenttoIncomeThirtyYear = Variables::outputs.InstalmentThirtyYear / Variables::inputs.HouseholdIncome _newline_Variables::outputs.PaymenttoIncomeThirtyYear = (Variables::outputs.PaymenttoIncomeThirtyYear).truncate_to(4)_newline__newline_Variables::outputs.LoantoValueThirtyYear =  Variables::inputs.LoanAmount / Variables::inputs.PropertyValue_newline_Variables::outputs.LoantoValueThirtyYear = (Variables::outputs.LoantoValueThirtyYear).truncate_to(4)_newline__newline_Variables::outputs.TermThirtyYear = 360_newline__newline_")},{-23, new Node(-23,"Application Qualifies for 30 Year Term",NodeType.Decision,@"if Variables::outputs.QualifiesForThirtyYearLoanTerm == true then_newline_  Variables::outputs.NodeResult = true_newline_else_newline_ Variables::outputs.NodeResult = false_newline__newline_  incomecontributorid = _sgl_quote__sgl_quote__newline__newline_  if Variables::inputs.HighestIncomeContributorIdentity != _sgl_quote__sgl_quote_ then _newline_    incomecontributorid =  _sgl_quote_ (_sgl_quote_+  Variables::inputs.HighestIncomeContributorIdentity + _sgl_quote_)_sgl_quote_ _newline_  end_newline_  _newline_    if  Variables::inputs.HighestIncomeContributorCreditScore < 595 ||_newline_        Variables::inputs.HighestIncomeContributorSalaryType == Enumerations::sAHomeLoans::householdIncomeType.SelfEmployed ||_newline_        Variables::inputs.HighestIncomeContributorAge < 18 ||_newline_          Variables::inputs.HighestIncomeContributorAge > 45 ||_newline_        (Variables::inputs.HighestIncomeContributorAge >= 40 && Variables::inputs.HouseholdIncome < 40000)_newline_    then_newline_        Messages.AddWarning(_sgl_quote_Highest Income Contributor is _sgl_quote_ + Variables::inputs.HighestIncomeContributorName + incomecontributorid + _sgl_quote_._sgl_quote_)_newline_    end   _newline_             _newline_ end")},{-25, new Node(-25,"Set Output Defaults",NodeType.Process,@"Variables::outputs.PaymenttoIncomeThirtyYear = -1_newline_Variables::outputs.InterestRateThirtyYear = -1_newline_Variables::outputs.LoantoValueThirtyYear = -1_newline_Variables::outputs.PricingAdjustmentThirtyYear = -1_newline_Variables::outputs.InstalmentThirtyYear = -1_newline_Variables::outputs.QualifiesForThirtyYearLoanTerm = true_newline_Variables::outputs.TermThirtyYear = 0_newline__newline_")},{-28, new Node(-28,"Is an Alpha Application",NodeType.Decision,@"if Variables::inputs.IsAlpha == true  then_newline_  Variables::outputs.NodeResult = true_newline_else_newline_ Variables::outputs.NodeResult = false_newline_end")},{-29, new Node(-29,"Display Warning Message for Alpha Applications",NodeType.Process,@"Messages.AddWarning(_sgl_quote_30 year term not available for Alpha Applications._sgl_quote_)_newline_Variables::outputs.QualifiesForThirtyYearLoanTerm = false")},{-31, new Node(-31,"Applicant Age < 18 Years",NodeType.Decision,@"if Variables::inputs.HighestIncomeContributorAge < 18  then_newline_  Variables::outputs.NodeResult = true_newline_else_newline_ Variables::outputs.NodeResult = false_newline_end")},{-34, new Node(-34,"Display Warning Message For Applicants below 18 years of age",NodeType.Process,@"Messages.AddWarning(_sgl_quote_Applicant must be 18 years or older._sgl_quote_)_newline_Variables::outputs.QualifiesForThirtyYearLoanTerm = false")},{-35, new Node(-35,"Display Warning Message For Applicants below 0 years of age",NodeType.Process,@"Messages.AddWarning(_sgl_quote_Applicant must have valid date of birth captured._sgl_quote_)_newline_Variables::outputs.QualifiesForThirtyYearLoanTerm = false")},{-37, new Node(-37,"Applicant Age <= 0",NodeType.Decision,@"if Variables::inputs.HighestIncomeContributorAge <= 0   then_newline_  Variables::outputs.NodeResult = true_newline_else_newline_ Variables::outputs.NodeResult = false_newline_end")},{-38, new Node(-38,"Is Interest Only",NodeType.Decision,@"if Variables::inputs.InterestOnly== true  then_newline_  Variables::outputs.NodeResult = true_newline_else_newline_ Variables::outputs.NodeResult = false_newline_end")},{-39, new Node(-39,"Display Warning Message for Interest Only",NodeType.Process,@"Messages.AddWarning(_sgl_quote_30 year term not available for Interest Only Applications._sgl_quote_)_newline_Variables::outputs.QualifiesForThirtyYearLoanTerm = false")}};
            this.systemMessageCollection = messages;
            SubtreeMessagesDictionary = new Dictionary<string, ISystemMessageCollection>();
            SubtreeMessagesToClear = new List<string>();
        }		
    }
}